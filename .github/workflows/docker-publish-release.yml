name: Build and Push Release Version for TEEHR Hub

on:
  workflow_run:
    workflows: ["publish-package"]  # Triggered by "publish-package" workflow
    types: [completed]              # Trigger when "publish-package" completes

jobs:
  get-existing-version:
    runs-on: ubuntu-latest
    outputs:
      pypi_version: ${{ steps.get_pypi_version.outputs.package_version }}
    steps:
      - name: Get Package Version from PyPI
        id: get_pypi_version
        run: |
          PACKAGE_VERSION=$(curl -s https://pypi.org/pypi/teehr/json | jq -r '.info.version')
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

  call-docker-build:
    uses: RTIInternational/teehr-hub/.github/workflows/build-and-push-image.yaml@update-deployment
    secrets: inherit
    needs: get-existing-version
    with:
      image-tag: ${{ github.ref_name }}
      previous-image-tag: ${{ needs.get-existing-version.outputs.pypi_version }}